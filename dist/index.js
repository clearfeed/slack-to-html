"use strict";var _index=_interopRequireDefault(require("xregexp/src/index")),_emoji=_interopRequireDefault(require("./emoji"));function _interopRequireDefault(c){return c&&c.__esModule?c:{default:c}}var expandEmoji=function(n){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,r=Object.assign({},_emoji.default,e);return n.replace(/:(\S+?):/g,function(s,t){for(var u=/alias:(\S+)/,o=t,l;l=r[o],!(!l||!l.match(u));)o=l.replace(u,"$1");if(o&&l){if(l.match(/https?:\/\/\S+/))return'<img alt="'.concat(t,'" src="').concat(l,'" title=":').concat(t,':" class="slack_emoji" />');var d=l.split("-").map(function(v){return"&#x".concat(v,";")}).join("");return a?d:'<span title=":'.concat(t,':">').concat(d,"</span>")}return s})},closingDivPatternString="</div>",closingSpanPatternString="</span>",codeDivOpeningPatternString='<div class="slack_code">',codeSpanOpeningPatternString='<span class="slack_code">',openingCodePatternString="<code>",closingCodePatternString="</code>",boldOpeningPatternString='<strong class="slack_bold">',boldClosingPatternString="</strong>",strikethroughOpeningPatternString='<s class="slack_strikethrough">',strikethroughClosingPatternString="</s>",italicOpeningPatternString='<em class="slack_italics">',italicClosingPatternString="</em>",blockDivOpeningPatternString='<div class="slack_block">',blockSpanOpeningPatternString='<blockquote class="slack_block">',blockSpanClosingPatternString="</blockquote>",paragraphBreak=_index.default.cache("\\n\\n","nsg"),paragraphBreakTagLiteral='<div class="slack_line_break"></div>',lineBreakTagLiteral="<br>",newlineRegExp=_index.default.cache("\\n","nsg"),whitespaceRegExp=_index.default.cache("\\s","ns"),slackMrkdwnCharactersRegExp=_index.default.cache("(?<mrkdwnCharacter>[\\*\\`\\~\\_]|&gt;)","ng"),slackMrkdwnPercentageCharsMap={"*":"%2A","&gt;":"%26gt;","`":"%27","~":"%7E",_:"%5F"},userMentionRegExp=_index.default.cache("<@(((?<userID>[U|W][^|>]+)(\\|(?<userName>[^>]+))?)|(?<userNameWithoutID>[^>]+))>","ng"),channelMentionRegExp=_index.default.cache("<#(((?<channelID>C[^|>]+)(\\|(?<channelName>[^>]*))?)|(?<channelNameWithoutID>[^>]+))>","ng"),linkRegExp=_index.default.cache("<(?<linkUrl>(https?|s3|ftp):[^|>]+)(\\|(?<linkHtml>[^>]+))?>","ng"),mailToRegExp=_index.default.cache("<mailto:(?<mailTo>[^|>]+)(\\|(?<mailToName>[^>]+))?>","ng"),telRegExp=_index.default.cache("<tel:(?<tel>[^|>]+)(\\|(?<telName>[^>]+))?>","ng"),subteamCommandRegExp=_index.default.cache("<!subteam\\^(?<subteamID>S[^|>]+)(\\|(?<subteamName>[^>]+))?>","ng"),commandRegExp=_index.default.cache("<!(?<commandLiteral>[^|>]+)(\\|(?<commandName>[^>]+))?>","ng"),knownCommands=["here","channel","group","everyone"],escapeTags=function(n){return["&lt;",n.substring(1,n.length-1),"&gt;"].join("")},replaceUserName=function(n){return function(e){var a=e.userName||e.userNameWithoutID||e.userID&&n&&n[e.userID];return a?'<span class="user-mention">@'.concat(a,"</span>"):escapeTags(e.toString())}},replaceChannelName=function(n){return function(e){var a=e.channelName||e.channelNameWithoutID||e.channelID&&n&&n[e.channelID];return a?"#".concat(a):escapeTags(e.channelID?"<#".concat(e.channelID,">"):e.toString())}},replaceUserGroupName=function(n){return function(e){var a=e.subteamName||e.subteamID&&n&&n[e.subteamID];return a?"@".concat(a):escapeTags(e.toString())}},buildOpeningDelimiterRegExp=function(n){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},a=e.prefixPattern,r=a===void 0?"":a,s=e.spacePadded,t=s===void 0?!1:s,u=e.escapeDelimiter,o=u===void 0?!0:u,l=o?_index.default.escape(n):n,d=t?`(?<openingCapturedWhitespace>^|\\s|["'])`:"";return _index.default.cache("".concat(d).concat(r).concat(l),"ns")},closingDelimiterAllowedChars=`"',.:!?`,buildClosingDelimiterRegExp=function(n){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},a=e.spacePadded,r=a===void 0?!1:a,s=e.escapeDelimiter,t=s===void 0?!0:s,u=t?_index.default.escape(n):n,o=r?"(?<closingCapturedWhitespace>\\s|[".concat(closingDelimiterAllowedChars,"]|$)"):"";return _index.default.cache("".concat(u).concat(o),"ns")},incrementWindows=function(n,e){return n.forEach(function(a){a[0]+=e,a[1]+=e}),n},_replaceInWindows=function(n,e,a,r,s){var t=arguments.length>5&&arguments[5]!==void 0?arguments[5]:{},u=arguments.length>6&&arguments[6]!==void 0?arguments[6]:0,o=arguments.length>7&&arguments[7]!==void 0?arguments[7]:0,l=t.partitionWindowOnMatch,d=t.spacePadded,v=t.endingPattern,D=t.replaceNewlines,m=t.maxReplacements,i=buildOpeningDelimiterRegExp(e,{spacePadded:d,prefixPattern:t.prefixPattern}),k=v?buildClosingDelimiterRegExp(t.endingPattern,{escapeDelimiter:!1}):buildClosingDelimiterRegExp(e,{spacePadded:d});if(u>=s.length||m&&m<=0)return{text:n,windows:s};var x=s[u],h=x[0],f=x[1];if(h>=f||h+o>f)return _replaceInWindows(n,e,a,r,s,t,u+1);var g=_index.default.exec(n,i,h+o);if(g&&g.index<f){for(var S=v?0:e.length,b=(u===s.length-1&&f===n.length?f+1:f)-S+1,p=_index.default.exec(n,k,g.index+e.length),P=p&&_index.default.exec(n,k,p.index+1);P;){var N=_index.default.exec(n,whitespaceRegExp,p.index+e.length),I=N&&N.index<b;if(P.index>=b||I)break;p=P,P=_index.default.exec(n,k,p.index+1)}if(p&&p.index<b){var _=p.index+p[0].length,W=n.slice(0,g.index),O=n.slice(_),$="".concat(d?g.openingCapturedWhitespace:"").concat(a),T="".concat(r).concat(d?p.closingCapturedWhitespace:"").concat(v?p[0]:""),E=n.slice(g.index+g[0].length,p.index);if(E.length===0)return _replaceInWindows(n,e,a,r,s,t,u,o+g[0].length);var C=D?_index.default.replace(E,newlineRegExp,lineBreakTagLiteral):E,B=[$,C,T].join(""),F=e.length+S,R=a.length+r.length-F+C.length-E.length,j=f+R,w=l?u+1:u,U=l?0:_+R-h+1;return l?(x[1]=g.index,s.splice(w,0,[p.index+S+R,j])):x[1]=j,incrementWindows(s.slice(w+1),R),m-=1,_replaceInWindows([W,B,O].join(""),e,a,r,s,Object.assign({},t,{maxReplacements:m}),w,U)}}return _replaceInWindows(n,e,a,r,s,t,u+1)},replaceParagraphBreaks=function(n){return _index.default.replace(n,paragraphBreak,paragraphBreakTagLiteral)},replaceBlockQuotes=function(n){var e=n.split(`
`),a=e.map(function(r){return r.trim().startsWith("&gt;")?_replaceInWindows(r,"&gt;",blockSpanOpeningPatternString,blockSpanClosingPatternString,[[0,r.length]],{prefixPattern:"^\\s*",endingPattern:"\\n|$",maxReplacements:1}).text:r});return a.join(`
`)},expandText=function(n){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,a;a={text:n,windows:[[0,n.length]]},a=_replaceInWindows(a.text,"```",codeDivOpeningPatternString+openingCodePatternString,closingCodePatternString+closingDivPatternString,a.windows,{partitionWindowOnMatch:!0,replaceNewlines:!0}),a=_replaceInWindows(a.text,"`",codeSpanOpeningPatternString+openingCodePatternString,closingCodePatternString+closingSpanPatternString,a.windows,{partitionWindowOnMatch:!0}),a=_replaceInWindows(a.text,"*",boldOpeningPatternString,boldClosingPatternString,a.windows,{maxReplacements:100,spacePadded:!0}),a=_replaceInWindows(a.text,"~",strikethroughOpeningPatternString,strikethroughClosingPatternString,a.windows,{maxReplacements:100,spacePadded:!0}),a=_replaceInWindows(a.text,"_",italicOpeningPatternString,italicClosingPatternString,a.windows,{maxReplacements:100,spacePadded:!0}),a=_replaceInWindows(a.text,"&gt;&gt;&gt;",blockDivOpeningPatternString,closingDivPatternString,a.windows,{prefixPattern:"^\\s*",endingPattern:"$",replaceNewlines:!0,maxReplacements:100});var r=replaceBlockQuotes(a.text);return e?r:replaceParagraphBreaks(r)},encodeSlackMrkdwnCharactersInLinks=function(n){return _index.default.replace(n,slackMrkdwnCharactersRegExp,function(e){return slackMrkdwnPercentageCharsMap[e.mrkdwnCharacter]||e.mrkdwnCharacter})},escapeForSlack=function(n){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},a=e.customEmoji||{},r=e.users||{},s=e.channels||{},t=e.usergroups||{},u=e.markdown||!1,o=e.skipEmojiSpans||!1,l=e.skipParagraphBreaks||!1,d=e.convertNewlinesToBr||!1,v=_index.default.replace(n||"",linkRegExp,function(i){var k=encodeSlackMrkdwnCharactersInLinks(i.linkUrl);return'<a href="'.concat(k,'" target="&#95;blank" rel="noopener noreferrer">').concat(i.linkHtml||k,"</a>")}),D=u?expandText(v,l):v,m=expandEmoji(_index.default.replaceEach(D,[[userMentionRegExp,replaceUserName(r)],[channelMentionRegExp,replaceChannelName(s)],[mailToRegExp,function(i){return'<a href="mailto:'.concat(i.mailTo,'" target="&#95;blank" rel="noopener noreferrer">').concat(i.mailToName||i.mailTo,"</a>")}],[telRegExp,function(i){return'<a href="tel:'.concat(i.tel,'">').concat(i.telName||i.tel,"</a>")}],[subteamCommandRegExp,replaceUserGroupName(t)],[commandRegExp,function(i){return i.commandLiteral&&i.commandLiteral.startsWith("subteam")?i.toString():knownCommands.includes(i.commandLiteral)?"@".concat(i.commandLiteral):i.commandName?"<".concat(i.commandName,">"):"<".concat(i.commandLiteral,">")}]]),a,o);return d?_index.default.replace(m,newlineRegExp,lineBreakTagLiteral):m},escapeForSlackWithMarkdown=function(n){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return escapeForSlack(n,Object.assign({},e,{markdown:!0}))},buildSlackHawkDownRegExps=function(){return{userMentionRegExp,channelMentionRegExp,linkRegExp,mailToRegExp,telRegExp,subteamCommandRegExp,boldOpeningDelimiterRegExp:buildOpeningDelimiterRegExp("*"),boldClosingDelimiterRegExp:buildClosingDelimiterRegExp("*"),italicsOpeningDelimiterRegExp:buildOpeningDelimiterRegExp("_",{spacePadded:!0}),italicsClosingDelimiterRegExp:buildClosingDelimiterRegExp("_",{spacePadded:!0}),strikethroughOpeningDelimiterRegExp:buildOpeningDelimiterRegExp("~"),strikethroughClosingDelimiterRegExp:buildClosingDelimiterRegExp("~"),blockDivOpeningDelimiterRegExp:buildOpeningDelimiterRegExp("&gt;&gt;&gt;"),blockDivClosingDelimiterRegExp:buildClosingDelimiterRegExp("$",{escapeDelimiter:!1}),blockSpanOpeningDelimiterRegExp:buildOpeningDelimiterRegExp("&gt;"),blockSpanClosingDelimiterRegExp:buildClosingDelimiterRegExp("\\n|$",{escapeDelimiter:!1})}};module.exports={escapeForSlack,escapeForSlackWithMarkdown,buildSlackHawkDownRegExps};
